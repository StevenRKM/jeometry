<html>

<head>
    <title>Jeometry Canvas</title>

    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>


<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript" src="../jeometry-primitives.js"></script>
<script type="text/javascript" src="../jeometry-utils.js"></script>
<script type="text/javascript" src="../jeometry-general.js"></script>
<script type="text/javascript" src="../jeometry-distance.js"></script>
<script type="text/javascript" src="../jeometry-intersect.js"></script>
<script type="text/javascript" src="../jeometry-orientation.js"></script>
<script type="text/javascript" src="../jeometry-random.js"></script>

<script type="text/javascript" src="js/canvas-drawing.js"></script>

<script type="text/javascript">
var radioButtonValues = {};
var checkboxButtonValues = {}

// TODO make better scene lookup
var previous = undefined;
var previousSegment = undefined;
var previousTriangle = undefined;
var previousPoints = Array();
var polygonBuild = Array();

$(document).ready(function() {
    // radio button group mechanism
    $(".btn-group[data-toggle='buttons-radio']").each(
            function(i, element) {
                element = $(element);
                radioButtonValues[element.data('name')] = element.data('value');
                element.find(".btn[data-value='"+element.data('value')+"']").addClass('active');
            }
    );

    $(".btn-group[data-toggle='buttons-radio'] .btn").click(
                function() {
                    // only change if different
                    group = $(this).closest(".btn-group");
                    if( group.data('value') != $(this).data('value') ) {
                        group.data('value', $(this).data('value'));
                        radioButtonValues[group.data('name')] = group.data('value');
                        radioButtonChanged(group.data('name'), group.data('value'));
                    }
                }
    );

    // checkbox button mechanism
    $(".btn[data-toggle='buttons-checkbox']").each(
            function(i, element) {
                element = $(element);
                checkboxButtonValues[element.data('name')] = element.hasClass('active');
            }
    );

    $(".btn[data-toggle='buttons-checkbox']").click(
            function() {
                // attributes reversed since class changes happen after
                checkboxButtonValues[$(this).data('name')] = !$(this).hasClass('active');
                checkboxButtonChanged( $(this).data('name'), !$(this).hasClass('active'));
            }
    );

    // regular button mechanism
    $(".btn-group[data-toggle!='buttons-radio'] .btn[data-toggle!='buttons-checkbox']").click(
            function() {
                buttonClicked($(this).data('name'));
            }
    );

    initCanvas({
        'canvas': $('#canvas'),
        'mouse': {
            'move': mouseMove,
            'down': mouseDown,
            'up': mouseUp,
            'out': mouseOut
        }
    });


    var mid = height/2;
    for(var i=200; i<=height-200; i+=10) {
        var segment = jeometry.primitives.segment(
                jeometry.primitives.point(100, mid),
                jeometry.primitives.point(1100, i)
        );
        segment.type = 9000;

        addSceneElement(segment, draw_reflection);
//        break;
    }
//    addSceneElement(jeometry.primitives.segment(
//            jeometry.primitives.point(600, 100),
//            jeometry.primitives.point(600, 500)
//    ));
//    p = jeometry.intersect(scene[1].primitive, scene[0].primitive);
//    if(p) {
//        addSceneElement(p);
//    }
    redraw();

});

function draw_reflection(element) {
    var max = 20;
    setStrokeColor("green");

    var segment = element.primitive.clone();

    draw_reflection_single(segment, max, undefined);
    setStrokeColor("red");

}

function draw_reflection_single(segment, max, last) {

    if(segment.length()<=0.0005)
        return;

//    setStrokeColor("orange");
//    if(segment.length()>=0.0005)
//        drawLine(segment);
    setStrokeColor("green");

    // stop condition
    if(max <= 0) {
        //drawLine(segment);
        return;
    }

    var intersection = undefined;
    for(var i in scene) {
        if(scene[i].primitive.type != jeometry.primitives.SEGMENT)
            continue;

        if(scene[i].primitive == last)
            continue;

        var segment2 = scene[i].primitive;
        var p = jeometry.intersection.segments_plus(segment, segment2);

        if(p!=undefined) {
            if(intersection==undefined) {
                intersection=p;
            } else if(p.segment1t < intersection.segment1t) {
                intersection=p;
            }
        }

    }

    if(intersection!=undefined) {
        drawLine( jeometry.primitives.segment(intersection.segment1.p1, intersection.point) );

        segment = jeometry.reflection(segment, intersection.segment2);
        segment.p2 = segment.p2.subtract(intersection.point).normalize().multiply_scalar(500).add(intersection.point);

        return draw_reflection_single(segment.clone(), max-1, intersection.segment2);
    }


    drawLine(segment);

}

function log(obj) {
	console.log(obj);
}

function radioButtonChanged(name, value) {
    log(name +" changed to "+value);

    redraw();
}

function checkboxButtonChanged(name, value) {
    log(name +" changed to "+value);

    redraw();
}

function buttonClicked(name) {
    log(name+" clicked");

    if(name == "clear") {
        clear();
    } else if(name == "undo") {
        scene.pop()
        redraw();
    } else if(name == "randomdots") {
        draw = function(element) {

            if( radioButtonValues["function"] == "orientation") {

                if(previousSegment != undefined) {
                    o = jeometry.orientation.get(previousSegment, element.primitive);
                    if(o==jeometry.orientation.LEFT) setFillColor("red");
                    else if(o==jeometry.orientation.RIGHT) setFillColor("green");
                    else if(o==jeometry.orientation.COLLINEAR) setFillColor("yellow");

                    drawPoint(element.primitive);
                    previousFillColor();
                } else {
                    drawPoint(element.primitive);
                }

            } else if( radioButtonValues["function"] == "in_triangle") {

                if(previousTriangle != undefined) {

                    if( jeometry.orientation.inside(element.primitive, previousTriangle) ) setFillColor("green");
                    else setFillColor("red");

                    drawPoint(element.primitive);
                    previousFillColor();
                } else {
                    drawPoint(element.primitive);
                }

            } else {
                drawPoint(element.primitive);
            }

        };

        for(i=0; i<100; i++)
            addSceneElement( jeometry.random.pointInBox(0,0,width, height), draw);

        redraw();
    }
}

// MOUSE

function mousePosition(e) {
    return jeometry.primitives.point(e.pageX-canvas.offsetLeft, e.pageY-canvas.offsetTop);
}

function mouseMove(pos) {
    //log("move " + pos.x +", "+pos.y);

    if( radioButtonValues["function"] == "orientation") {

        redraw();

        if(previousSegment != undefined) {
            o = jeometry.orientation.get(previousSegment, pos);
            if(o==jeometry.orientation.LEFT) setFillColor("red");
            else if(o==jeometry.orientation.RIGHT) setFillColor("green");
            else if(o==jeometry.orientation.COLLINEAR) setFillColor("yellow");

            drawPoint(pos);
            previousFillColor();
        } else {
            drawText("No previous segment", jeometry.primitives.point(100,100));
            drawPoint(pos);
        }

    } else if( radioButtonValues["function"] == "in_triangle") {

        redraw();

        if(previousTriangle != undefined) {

            if( jeometry.orientation.inside(pos, previousTriangle) ) setFillColor("green");
            else setFillColor("red");

            drawPoint(pos);
            previousFillColor();
        } else {
            drawText("No previous triangle", jeometry.primitives.point(100,100));
            drawPoint(pos);
        }

    } else if(radioButtonValues["function"] == "reflection") {

        if( previous != undefined) {
            redraw();

            var segment = jeometry.primitives.segment(previous, pos);
//            drawLine( segment );

            setStrokeColor("green");

            var hits = 0;

            for(var i in scene) {
                log("check "+i);

                if(scene[i].primitive.type == jeometry.primitives.SEGMENT) {

                    var segment2 = scene[i].primitive;
                    var p = jeometry.intersection.get(segment2, segment);

                    if(p!=undefined) {
                        drawLine( jeometry.primitives.segment(segment.p1, p) );

                        segment = jeometry.reflection(segment, segment2);
//                        drawLine(segment);
                        hits++;
                        if(hits>3) {
                            log("max");
                            return;
                        } else {
                            log("reset");
                            i=0;
                        }

                    }
                }

            }

        }

        drawLine( segment );
        setStrokeColor("red");

    } else if( radioButtonValues["primitive"] == "line"
                || radioButtonValues["primitive"] == "segment") {
        if( previous != undefined) {
            redraw();

            var segment = jeometry.primitives.segment(previous, pos);

            if(scene.length > 0
                    && scene[scene.length-1].primitive.type == jeometry.primitives.SEGMENT
                    && scene[scene.length-1].primitive.p1.x == previous.x
                    && scene[scene.length-1].primitive.p1.y == previous.y) {
                scene[scene.length-1].primitive.p2 = pos.clone();
            } else {
                addSceneElement(segment);
            }

            drawLine( jeometry.primitives.segment(previous, pos) );

            var rgb = new RGBAColor();
            var points;
            for(var i in scene) {

                if(scene[i].primitive.type == jeometry.primitives.SEGMENT) {
                    var p = jeometry.intersection.segments_plus(segment, scene[i].primitive);
                    if(p!=undefined) {
                        rgb.setFromHSV(100* p.segment2t, 1, 1);
                        setFillColor("rgb("+rgb.r+","+rgb.g+","+rgb.b+")");
                        drawPoint(p.point);
                    }
                }

//                if(scene[i].primitive.type == jeometry.primitives.TRIANGLE && p != undefined && p.length != undefined && p.length == 2) {
//
//                    var triangle = scene[i].primitive;
//
//                    var p1 = jeometry.intersection.get(triangle.side1, segment);
//                    var p2 = jeometry.intersection.get(triangle.side2, segment);
//                    var p3 = jeometry.intersection.get(triangle.side3, segment);
//
//                    var t1 = triangle.p1;
//                    var t2 = triangle.p2;
//                    var t3 = triangle.p3;
//
//                    var on_poly1 = true;
//
//                    var polygon1 = Array();
//                    var polygon2 = Array();
//
//                    if(on_poly1) polygon1.push(t1); else polygon2.push(t1);
//                    if(p1) {
//                        polygon1.push(p1);
//                        polygon2.push(p1);
//                        on_poly1 = !on_poly1;
//                    }
//                    if(on_poly1) polygon1.push(t2); else polygon2.push(t2);
//                    if(p2) {
//                        polygon1.push(p2);
//                        polygon2.push(p2);
//                        on_poly1 = !on_poly1;
//                    }
//                    if(on_poly1) polygon1.push(t3); else polygon2.push(t3);
//                    if(p3) {
//                        polygon1.push(p3);
//                        polygon2.push(p3);
//                        on_poly1 = !on_poly1;
//                    }
//
//                    if(polygon1.length > 2) {
//                        setFillColor("green");
//                        drawPolygon(jeometry.primitives.polygon(polygon1));
//                        previousFillColor();
//                    }
//
//                    if(polygon2.length > 2) {
//                        setFillColor("orange");
//                        drawPolygon(jeometry.primitives.polygon(polygon2));
//                        previousFillColor();
//                    }
//
//
//
//                }

            }

        }
    } else if( radioButtonValues["primitive"] == "triangle") {

        for(i in previousPoints)
            drawPoint(previousPoints[i]);
    }

}

function mouseDown(pos) {
	//log("down " + pos.x +", "+pos.y);

    if( radioButtonValues["primitive"] == "point") {
        addSceneElement(pos); //drawPoint(pos);
        redraw();

        if(previousSegment != undefined) {
            o = orientation(previousSegment.p1, previousSegment.p2, pos);
            if(o==ORIENTATION_LEFT) log("left");
            else if(o==ORIENTATION_RIGHT) log("right");
            else if(o==ORIENTATION_COLLINEAR) log("collinear");
        }

    } else if( radioButtonValues["primitive"] == "segment"
            || radioButtonValues["primitive"] == "line") {
        previous = pos;
    } else if( radioButtonValues["primitive"] == "triangle") {

        if(previousPoints.length < 2) {
            previousPoints.push(pos);
            for(i in previousPoints)
                drawPoint(previousPoints[i]);

        } else {
            t = jeometry.primitives.triangle(previousPoints[0],previousPoints[1],pos)
            previousTriangle = t;
            addSceneElement( t );
            previousPoints.splice(0, previousPoints.length);
            redraw();
        }
    } else if( radioButtonValues["primitive"] == "polygon") {

        polygonBuild.push(pos);

        if(polygonBuild.length < 3) {
            for(i in polygonBuild)
                drawPoint(polygonBuild[i]);

        } else {

            clear();
            drawPolygon(jeometry.primitives.polygon(polygonBuild));
        }
    }


}

function mouseUp(pos) {
	//log("up " + pos.x +", "+pos.y);

    if( radioButtonValues["primitive"] == "point") {

    } else if( radioButtonValues["primitive"] == "segment") {
        if( previous != undefined) {
//            addSceneElement( jeometry.primitives.segment(previous, pos) );
            previousSegment = jeometry.primitives.segment(previous, pos);
        }
        previous = undefined;

        redraw();
    } else if( radioButtonValues["primitive"] == "line") {
        if( previous != undefined) {
            addSceneElement( jeometry.primitives.segment(previous, pos) );
            previousSegment = jeometry.primitives.segment(previous, pos);
        }
        previous = undefined;

        redraw();
    } else if( radioButtonValues["primitive"] == "triangle") {
    }
}

function mouseOut(pos) {
	//log("out " + pos.x +", "+pos.y);
}

</script>

<body style="background-color: #111111">

    <div class="">

        <div class="row">

            <div class="span5">

                <div class="btn-group" data-toggle="buttons-radio" data-value="draw" data-name="function">
                    <button class="btn btn-large btn-primary" data-value="draw" >Draw</button>
                    <button class="btn btn-large btn-primary" data-value="orientation">Orientation</button>
                    <button class="btn btn-large btn-primary" data-value="in_triangle">In</button>
                    <button class="btn btn-large btn-primary" data-value="reflection">Reflection</button>
                </div>

                <br/>

                <div class="btn-group" data-toggle="buttons-radio" data-value="point" data-name="primitive">
                    <button class="btn btn-large btn-primary" data-value="point" >Point</button>
                    <!--<button class="btn btn-large btn-primary" data-value="line">Line</button>-->
                    <button class="btn btn-large btn-primary" data-value="segment">Segment</button>
                    <button class="btn btn-large btn-primary" data-value="triangle">Triangle</button>
                    <button class="btn btn-large btn-primary" data-value="polygon">Polygon</button>
                </div>

                <br/>

                <div class="btn-group">
                    <!--<button class="btn btn-large btn-info active" data-toggle="buttons-checkbox" data-name='coordinates'>Coordinates</button>-->
                    <button class="btn btn-large btn-info" data-toggle="buttons-checkbox" data-name='coordinates'>Coordinates</button>
                    <button class="btn btn-large btn-info" data-toggle="buttons-checkbox" data-name='distances'>Distances</button>
                </div>

                <br/>

                <div class="btn-group">
                    <button class="btn btn-large btn-success" data-name='randomdots'>Dots</button>
                </div>

                <br/>

                <div class="btn-group">
                    <button class="btn btn-large btn-warning" data-name='clear'>Clear</button>
                    <button class="btn btn-large btn-warning" data-name='undo'>Undo</button>
                </div>

                <br/>

            </div>

            <div class="span11 offset1">
                <canvas id="canvas" width="1400"height="800" style="border:2px solid;"></canvas>
            </div>

        </div>

    </div>

</body>
